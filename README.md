# Balance & Task Distribution Web Application

Распределенное веб-приложение для обновления баланса пользователя и выполнения фоновых задач в распределенной среде.

## Технологии

- Node.js
- Express
- PostgreSQL
- Sequelize ORM
- Umzug (для миграций)
- Node-cron (для планирования задач)

## Особенности

- **Управление балансом пользователя**:
  - Атомарное обновление баланса
  - Предотвращение отрицательного баланса
  - Обработка конкурентных запросов

- **Распределенное выполнение задач**:
  - Равномерное распределение задач между серверами
  - Предотвращение дублирования выполнения одной задачи
  - Задачи выполняются не менее 2 минут
  - Управление блокировками через базу данных
  - Запись истории выполнения задач

## Структура проекта

```
src/
  ├── config/        # Конфигурация приложения
  ├── controllers/   # Контроллеры API
  ├── middlewares/   # Middleware компоненты
  ├── migrations/    # Миграции базы данных
  ├── models/        # Модели данных
  ├── routes/        # Маршруты API
  ├── services/      # Бизнес-логика
  │   └── cronService.js  # Сервис для управления фоновыми задачами
  ├── utils/         # Вспомогательные функции
  ├── validators/    # Валидаторы запросов
  └── app.js         # Точка входа в приложение
```

## Установка и запуск

1. Клонируйте репозиторий
```bash
git clone https://github.com/yourusername/balance-webapp.git
cd balance-webapp
```

2. Установите зависимости
```bash
npm install
```

3. Создайте файл .env с параметрами подключения к базе данных
```
DATABASE_URL=postgres://username:password@localhost:5432/balance_db
PORT=3000
SERVER_ID=server-1  # Уникальный ID сервера
```

4. Запустите миграции
```bash
npm run migrate
```

5. Запустите приложение в одном экземпляре
```bash
npm start
```

6. Для запуска нескольких экземпляров приложения используйте скрипт
```bash
chmod +x start-servers.sh
./start-servers.sh
```

## API

### Управление балансом

`POST /api/users/update-balance`

Тело запроса:
```json
{
  "userId": 1,
  "amount": 100.50
}
```

### Управление задачами

`GET /api/tasks`
Получение списка всех задач с информацией о их текущем статусе

`GET /api/tasks/:taskId`
Получение подробной информации о конкретной задаче

`GET /api/tasks/history`
Получение истории выполнения задач

`GET /api/tasks/:taskId/history`
Получение истории выполнения конкретной задачи

`POST /api/tasks/:taskId/run`
Ручной запуск задачи

`GET /api/tasks/stats/summary`
Получение статистики по выполнению задач

## Распределение нагрузки

Для распределения запросов между серверами можно использовать Nginx:

1. Установите Nginx
```bash
sudo apt update
sudo apt install nginx
```

2. Скопируйте конфигурацию из файла nginx.conf в директорию /etc/nginx/conf.d/
```bash
sudo cp nginx.conf /etc/nginx/conf.d/balance-webapp.conf
```

3. Проверьте конфигурацию и перезапустите Nginx
```bash
sudo nginx -t
sudo systemctl restart nginx
```

## Архитектура системы распределенных задач

Система спроектирована таким образом, что каждый экземпляр приложения работает независимо, без знания о других экземплярах:

1. **Блокировка задач**: Для предотвращения дублирования задач используется механизм блокировок в базе данных. Перед выполнением задачи сервер пытается получить блокировку, и только если это успешно, задача выполняется.

2. **Равномерное распределение**: При запуске каждый сервер пытается захватить свободные задачи. Благодаря использованию транзакций и блокировок в базе данных, задачи распределяются равномерно.

3. **Мониторинг**: Через API можно в реальном времени получить информацию о том, какие задачи выполняются, на каких серверах и как долго.

4. **Отказоустойчивость**: Если сервер выходит из строя, его блокировки истекают автоматически, и другие серверы подхватывают задачи.